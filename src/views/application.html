{% extends 'layout.html' %}

{% block head %}
        <link rel="stylesheet" href="css/application.css" />
        <link rel="stylesheet" href="css/jquery-ui-1.8.18.custom.css" />
        <link rel="stylesheet" href="JQuery-PLUGIN/jquery.svg.css" />
        <script src="js/jquery-1.7.1.js"></script>
        <script src="js/jquery-ui-1.8.18.custom.min.js"></script>
        <script src="js/jeditable.mini.js"></script>
        <script src="js/json2.js"></script>
        <script src="JQuery-PLUGIN/jquery.svg.min.js"></script>
        <script src="JQuery-PLUGIN/jquery.svganim.min.js"></script>
        <script src="JQuery-PLUGIN/jquery.svgdom.min.js"></script>
        <script src="js/Partition.js"></script>
        <script src="js/Instrument.js"></script>
        <script src="js/TrackPart.js"></script>
        <script src="js/Lines.js"></script>
        <script src="js/Measure.js"></script>
        <script src="js/Attribute.js"></script>
        <script src="js/Chord.js"></script>
        <script src="js/SoundParam.js"></script>
        <script src="js/Note.js"></script>
        <script src="js/Parser.js"></script>
        <script src="js/Event.js"></script>
        <script src="js/DrawNote.js"></script>
        <script src="js/Draw.js"></script>
        <script type="text/javascript">
                if (config) {
                        alert('conflit entre 2 variables');
                        debugger;
                }
                var config = {
                        tablature: '{{tablature}}'
                }
        </script>

{% endblock %}

{% block content %}
        <section class="page">
            <section class="float-left">
                <section class="header">
                    <section class="player_section float-left">
                        <section class="player">
                            <img id="back" src="image/playerback.png" />
                            <img id="play" src="image/playerplay.png" />
                            <img id="pause" src="image/playerpause.png" />
                            <img id="stop" src="image/playerstop.png" />
                        </section>
                        <section class="player_options">
                            <section class="float-left">
                                <img id="tempo" class="float-left" src="image/tempo.png" />
                                <section class="text float-left tempo"></section>
                                <section class="clear"></section>
                            </section>
                            <section class="float-left">
                                <img id="speed" class="float-left" src="image/vitesse.png" />
                                <section class="text float-left">x 1.00</section>
                                <section class="clear"></section>
                            </section>
                            <section class="clear"></section>
                        </section>
                    </section>
                    <section class="instruments float-right">
                    </section>
                    <section class="clear"></section>
                </section>
                <section class="tab_svg overflow_svg">
                    <!--<embed src="SVG/partition.svg" width="900" height="400" type="image/svg+xml" />-->
                </section>
                <section class="progress_bar overflow_measure">
                    <table>
                        <tr>
                        </tr>
                        <tr>
                        </tr>
                    </table>
                </section>
                <footer>
                </footer>
            </section>
            <section class="clear"></section>
        </section>

<script type="text/javascript">

    var svg_inst = new Array();
    var current_svg = 0;

    $(document).ready (function()
    {
        $(".tab_svg").css("height",6000);
        $(".tempo").text(partition._instruments_list[0]._track_part._measure_list[0]._sound_params._tempo);

        for (var i = 0; i < partition._instruments_list.length; i++)
        {
            var nb_corde = partition._instruments_list[i]._track_part._tuning.length;
            if (i == 0)
            {
                $(".tab_svg").append("<section id='"+i+"' style='display: block;'></section>");
            }
            else
            {
                $(".tab_svg").append("<section id='"+i+"' style='display: none;'></section>");
            }
            $(".tab_svg #"+i).svg({onLoad: function(svg)
            {
                svg_inst.push(svg);
                //var height = 60 + Math.ceil((80 * (nb_measure / 4))) < 400 ? 400 : 60 + Math.ceil((80 * (nb_measure / 4)));
               var height = 6000;
               svg.rect(0, 0, 900, height, { fill: "white", stroke:"black"});
               try
               {

                   DrawPartition (partition._instruments_list[i]._track_part._measure_list, svg, nb_corde);
                    svg.rect(60, 20, 2, (nb_corde * 10 + 10), {id: "cursor_"+i, fill:"red"});
               }
               catch (err)
               {
                   writeInConsole (err.message + " line : " + err.stack);
               }
              

            }
        });
        }
        /*
        $('.tab_svg').svg({onLoad: function(svg)
        {
            svg_inst = svg;
            var height = 60 + Math.ceil((80 * (nb_measure / 4))) < 400 ? 400 : 60 + Math.ceil((80 * (nb_measure / 4)));
            svg.rect(0, 0, 900, height, { fill: "white", stroke:"black"});
            drawLines(svg);
        }
        });*/

        


      

       

       
           
        
 

        


      
            
        
        function drawTAB (svg, y, nb_corde, indice_mesure)
        {
            if (indice_mesure == 0)
                {
                    svg.text(20, 45, "T");
                    svg.text(20, 60, "A");
                    svg.text(20, 75, "B"); 
                    
                }
            else
                {
                    svg.text(20, y + 15 , "T");
                    svg.text(20, y+ 30 , "A");
                    svg.text(20, y+ 45 , "B"); 
                }
        }
        
        function draw_it (array, width, mes, nb_corde, x, y, svg, svg_index, measure)
        {
                 var h = nb_corde * 10 -10; 
                drawMeasures(svg, svg_index, nb_corde, width, x, y, h, mes);
                drawLines(svg, x,y,width, nb_corde);
               // drawNotes(svg, svg_index, array, measure , mes);        
        }
        
        $($("rect[id^='m_']"), svg_inst[current_svg].root()).click(function (){
            var id = $(this).attr("id");
            if ($("img[id='"+id+"']").attr("src") == "image/casegrise.png")
            {
                $("img[id='m_"+selected+"']").attr("src", "image/casegrise.png");
                $("img[id="+id+"]").attr("src", "image/casebleue.png");
                var array = id.split('_');
                selected = array[1];
                elapsed_time = (selected % 4) == 0 ? (speed * 0.75) : ((speed / 4) * ((selected % 4) - 1));
                line = (selected % 4 == 0) ? (((selected / 4) | 0) - 1) : ((selected / 4) | 0);
                $($("rect[id^='cursor']"), svg_inst[current_svg].root()).attr({"y": (20 + (80 * line)), transform:"translate("+ ($($("rect[id='m_"+selected+"']"), svg_inst[current_svg].root()).attr("x") - 60) +" 0)"});
            }
        });

        $(".tempo").editable(
            function(value, settings) {
                var tempo = value;
                var beat = partition._instruments_list[0]._track_part._measure_list[0]._attributes._time_beat;
                speed = (((beat * 4) * 60) / tempo) * 1000;

                return value;
            },
            {
                event : "dblclick",
                style : "inherit"
        });
        
		
        
         $.ajax({
            type: "POST",
            url: 'midi',
			data: { 'encoded' : JSON.stringify({ encoded : partition })},
			dataType: "json",
            success: function (data, textStatus, jqXHR) {
				$(".page").append(
				"<object classid='clsid:02BF25D5-8C17-4B23-BC80-D3488ABDDC6B'"+
				"codebase='http://www.apple.com/qtactivex/qtplugin.cab' width='180'"+
				"height='160' id='demo'>"+
				"<param name='src' value='js/demo.mid'>"+
				"<param name='Autoplay' value='false'>"+
				"<embed width='0' height='0' src='js/demo.mid' name='demo'"+
				"enablejavascript='true' autostart='false'>"+
				"</object>"
				);
            },
            error: function (xhr, status, err) {
                alert("fail");
            }
        });

    });
</script>
{% endblock %}
