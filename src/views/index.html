{% extends 'layout.html' %}

{% block title %}EasyTab{% endblock %}

{% block head %}
<link rel="stylesheet" href="/css/smoothness/jquery-ui-1.8.18.custom.css" />
<link rel="stylesheet" href="/css/site.css">
<script src="/js/jquery-1.7.1.js"></script>
<script src="/js/jquery-ui-1.8.18.custom.min.js"></script>
<script src="/js/jquery.contextmenu.r2.packed.js"></script>
<script type="text/javascript">
	var config = {
		page: {{page}}
	};
	function search(option, param) {
		var recherche = $('#searchForm > input').val();
		var url = '/search/';
		if (option === undefined) {
			url += recherche;
		} else {
			url += 'o;'+option+'/'+recherche;
		}
		url += '?page='+config.page;
		if (param) {
			if (param.asc) url += '&asc=1';
			if (param.desc) url += '&desc=1';
		}

		$.post(url, function(data, textStatus) {
			$('#trackList tbody').empty();
			for (var i = 0; i < data.length; ++i) {
				$('#trackList tbody').append('<tr id="tab_'+data[i].id+'">'
					+'<td><a href="application;'+data[i].nom+'.xml">'+ data[i].titre+'</a></td>'
					+'<td>'+data[i].artiste+'</td>'
					+'<td><a href="user/'+data[i].userId+'/'+data[i].login+'">'+ data[i].login+'</td>'
					+'</tr>');
			}
		}, 'json');
	}
	$(function(){
		// au double clic on ouvre la partition
		$('#trackList > tbody > tr').dblclick(function(e){
			location.href = $('a', this).attr('href');
		});
		// recherche automatique dès qu'on lache une touche
		$('#searchForm > input').keyup(function(e){
			if (e.which == 27) {
				$(this).val('');
				search();
			} else {
				search();
			}
		});
		// interception de l'appui sur la touche entrée pour rechercher sans changer de page
		$('#searchForm').submit(function(e){
			e.preventDefault();
			search();
		});
		// bouton rechercher
		$('#searchForm > .search_button').click(function(e){
			search();
		});
		// recherche sur les colonnes
		var colHeadTd = $('#trackList > thead td');
		$(colHeadTd[0]).toggle(
			function(){search('titre', {asc:true});},
			function(){search('titre', {desc:true});}
		);
		$(colHeadTd[1]).toggle(
			function(){search('artiste', {asc:true});},
			function(){search('artiste', {desc:true});}
		);
		$(colHeadTd[2]).toggle(
			function(){search('userId', {asc:true});},
			function(){search('userId', {desc:true});}
		);
		// récupérer les favoris
		$('#trackList>tbody>tr').each(function(i, elem){
			var id = $(elem).attr('id').slice(4);
			$.get('/fav/get/'+id+'/!', function(data, textStatus, jqXHR) {
				if (data.error) console.error('erreur');
				if (data.favori) {
					$(elem).addClass('fav');
				}
			}, 'json');
		});
		// activer le menu contextuel
		var postOnClick = function(data, textStatus, jqXHR) {
			if (data.success) {
				var id = data.tablatureId;
				$('#tab_'+id).toggleClass('fav');
			}
		}
		var menu1 = {
			bindings: {
				'ouvrir': function(t) {
					location.href = $('a', t).attr('href');
				},
				'favoris': function(t) {
					var id = $(t).attr('id').slice(4);
					if ($(t).hasClass('fav')) {
						$.post('/fav/del/'+id+'/!', postOnClick, 'json');
					} else {
						$.post('/fav/add/'+id+'/!', postOnClick, 'json');
					}
				}
			},
			menuStyle: {
				width: '133px'
			}
		};
		$('#trackList tbody tr').contextMenu('menu1', menu1);
		$('#trackList tbody tr').mousedown(function(){
			if ($(this).hasClass('fav')) {
				$('#menu1 #favoris>a').html('Retirer des favoris');
			} else {
				$('#menu1 #favoris>a').html('Ajouter aux favoris');
			}
		});
		var staticSens = {
			date: true,
			alpha: true,
		};
		var menuOption = {
			bindings: {
				'date': function(e) {
					if (staticSens.date) {
						search('date', {asc:true});
					} else {
						search('date', {desc:true});
					}
					staticSens.date = !staticSens.date;
					
				},
				'alpha': function(e) {
					if (staticSens.alpha) {
						search('alpha', {asc:true});
					} else {
						search('alpha', {desc:true});
					}
					staticSens.alpha = !staticSens.alpha;
				}
			},
			menuStyle: {
				width: '233px'
			}
		};
		$('#trackList thead tr').contextMenu('menuOption', menuOption);
	});
</script>
{% endblock %}

{% block content %}
<div id="wrapper" class="center">
	<div class="containerTransparent"></div>
	<section id="container">
		{% if success %}
		<div class="ui-state-highlight ui-corner-all" style="padding: 0 .7em;">
			<p>
				<span class="ui-icon ui-icon-info" style="float: left; margin-right: .3em;"></span>
				{{ success }}
			</p>
		</div>
		{% endif %}
		{% if error %}
		<div class="error ui-state-error ui-corner-all">
			<p>
				<span class="error ui-icon ui-icon-alert"></span>
				{{ error }}
			</p>
		</div>
		{% endif %}
		<div class="top-container">
			<h2 class="center">Partitions</h2>
		</div>
		<div class="content-container center">
			<div class="left-content">
				<form id="searchForm">
					<input id="searchBox" placeholder="Rechercher...">
					<span class="search_button"></span>
				</form>
				<table id="trackList">
					<thead>
						<tr>
							<td><span>Titre</span></td>
							<td><span>Artiste</span></td>
							<td><span>Uploadé par</span></td>
						</tr>
					</thead>
					<tbody>
						{% for xml in pistes -%}
						<tr id="tab_{{xml.id}}">
							<td><a href="application;{{ xml.nom }}.xml">{{xml.titre}}</a></td>
							<td>{{xml.artiste}}</td>
							<td><a href="user/{{xml.userId}}/{{xml.login}}" title="Mis en ligne par {{xml.login}}">{{xml.login}}</td>
						</tr>
						{%- endfor %}
					</tbody>
				</table>
				<div id="pageBarre">
					<span class="">Page</span>
					{% for page in pages -%}
					<a href="?page={{page}}">{{page}}</a>
					{%- endfor %}
				</div>
			</div>
			<div class="right-content">
				<h2>Top 5</h2>
				<ul>
					{% for xml in top5 -%}
					<a href="application;{{ xml.nom }}.xml"><li>{{xml.artiste}} - {{ xml.titre}}</li></a>
					{%- endfor %}
				</ul>
				<h2>Derniers Ajouts</h2>
				<ul>
					{% for xml in last -%}
					<a href="application;{{ xml.nom }}.xml"><li>{{xml.artiste}} - {{ xml.titre}}</li></a>
					{%- endfor %}
				</ul>
			</div>
		</div>
	</section>
</div>
<div class="contextMenu" id="menu1">
	<ul>
		<li id="ouvrir">
			<a>Ouvrir</a>
		</li>
		<li id="favoris">
			<a>Ajouter aux favoris</a>
		</li>
	</ul>
</div>
<div class="contextMenu" id="menuOption">
	<ul>
		<li id="date"><a>Trier par date d'ajout</a></li>
		<li id="alpha"><a>Trier par nom de fichier</a></li>
	</ul>
</div>
<div id="dialog"></div>
{% endblock %}